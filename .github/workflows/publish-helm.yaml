name: Publish Helm Charts to GitHub Pages

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  push:
    branches:
      - master
    paths:
      - 'helm/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.DEVI_PAT_TOKEN }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Add Bitnami repo
        run: helm repo add bitnami https://charts.bitnami.com/bitnami && helm repo update

      - name: Lint local Helm charts (e.g. nginx-multiple)
        run: |
          for chart in $(find helm -maxdepth 1 -mindepth 1 -type d); do
            helm lint "$chart"
          done

      - name: Create chart output directory
        run: mkdir -p .chart-out

      - name: Package latest 10 Bitnami Apache charts
        run: |
          VERSIONS=$(helm search repo bitnami/apache --versions -o json | jq -r '.[].version' | head -n 10)
          while IFS= read -r VERSION; do
            echo "Packaging Apache $VERSION"
            helm pull bitnami/apache --version "$VERSION" --untar --untardir .chart-tmp
            helm package .chart-tmp/apache --version "$VERSION" --app-version "$VERSION" -d .chart-out
            rm -rf .chart-tmp/apache
          done <<< "$VERSIONS"

      - name: Package custom charts (e.g. nginx-multiple)
