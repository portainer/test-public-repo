name: Publish Helm Charts to GitHub Pages

on:
  push:
    branches:
      - master
    paths:
      - 'helm/**'
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.DEVI_PAT_TOKEN }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Add Bitnami repo
        run: helm repo add bitnami https://charts.bitnami.com/bitnami && helm repo update

      - name: Lint local charts
        run: |
          for chart in $(find helm -maxdepth 1 -mindepth 1 -type d); do
            helm lint "$chart"
          done

      - name: Create working directories
        run: mkdir -p .chart-out .chart-tmp .gh-pages

      - name: Fetch existing gh-pages
        run: |
          git fetch origin gh-pages
          git worktree add .gh-pages origin/gh-pages || echo "No gh-pages branch yet"

      - name: Preserve existing charts
        run: |
          cp .gh-pages/*.tgz .chart-out/ 2>/dev/null || true
          cp .gh-pages/index.yaml .chart-out/index.yaml 2>/dev/null || true

      - name: Determine existing Redis versions
        id: redis-versions
        run: |
          EXISTING=$(yq -r '.entries.redis[].version' .chart-out/index.yaml 2>/dev/null || echo "")
          echo "existing_versions<<EOF" >> $GITHUB_OUTPUT
          echo "$EXISTING" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Determine existing nginx versions
        id: nginx-versions
        run: |
          EXISTING=$(yq -r '.entries.nginx[].version' .chart-out/index.yaml 2>/dev/null || echo "")
          echo "existing_versions<<EOF" >> $GITHUB_OUTPUT
          echo "$EXISTING" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Package new Redis versions
        run: |
          EXISTING="${{ steps.redis-versions.outputs.existing_versions }}"
          LATEST=$(helm search repo bitnami/redis --versions -o json | jq -r '.[].version' | head -n 15)

          for VERSION in $LATEST; do
            if echo "$EXISTING" | grep -Fqx "$VERSION"; then
              echo "‚è© Skipping already packaged Redis $VERSION"
            else
              echo "üì¶ Packaging Redis $VERSION"
              helm pull bitnami/redis --version "$VERSION" --untar --untardir .chart-tmp

              # Extract the common version that redis requires
              REQUIRED_COMMON=$(yq -r '.dependencies[] | select(.name=="common") | .version' .chart-tmp/redis/Chart.yaml)
              echo "  redis $VERSION requires common $REQUIRED_COMMON"

              # Check if this common version is already packaged
              EXISTING_COMMON=$(yq -r '.entries.common[]?.version' .chart-out/index.yaml 2>/dev/null || echo "")
              if ! echo "$EXISTING_COMMON" | grep -Fqx "$REQUIRED_COMMON"; then
                echo "  üì¶ Packaging common $REQUIRED_COMMON (required by redis)"
                helm pull bitnami/common --version "$REQUIRED_COMMON" -d .chart-out
              else
                echo "  ‚úÖ common $REQUIRED_COMMON already packaged"
              fi

              # Remove bundled charts to avoid version conflicts
              rm -rf .chart-tmp/redis/charts/
              rm -f .chart-tmp/redis/Chart.lock

              # Update Chart.yaml to point to our GitHub repo
              sed -i 's|repository: oci://registry-1.docker.io/bitnamicharts|repository: https://portainer.github.io/test-public-repo|g' .chart-tmp/redis/Chart.yaml

              helm package .chart-tmp/redis --version "$VERSION" --app-version "$VERSION" -d .chart-out
              rm -rf .chart-tmp/redis
            fi
          done

      - name: Package new nginx versions
        run: |
          EXISTING="${{ steps.nginx-versions.outputs.existing_versions }}"
          LATEST=$(helm search repo bitnami/nginx --versions -o json | jq -r '.[].version' | head -n 15)

          for VERSION in $LATEST; do
            if echo "$EXISTING" | grep -Fqx "$VERSION"; then
              echo "‚è© Skipping already packaged nginx $VERSION"
            else
              echo "üì¶ Packaging nginx $VERSION"
              helm pull bitnami/nginx --version "$VERSION" --untar --untardir .chart-tmp

              # Extract the common version that nginx requires
              REQUIRED_COMMON=$(yq -r '.dependencies[] | select(.name=="common") | .version' .chart-tmp/nginx/Chart.yaml)
              echo "  nginx $VERSION requires common $REQUIRED_COMMON"

              # Check if this common version is already packaged
              EXISTING_COMMON=$(yq -r '.entries.common[]?.version' .chart-out/index.yaml 2>/dev/null || echo "")
              if ! echo "$EXISTING_COMMON" | grep -Fqx "$REQUIRED_COMMON"; then
                echo "  üì¶ Packaging common $REQUIRED_COMMON (required by nginx)"
                helm pull bitnami/common --version "$REQUIRED_COMMON" -d .chart-out
              else
                echo "  ‚úÖ common $REQUIRED_COMMON already packaged"
              fi

              # Remove bundled charts to avoid version conflicts
              rm -rf .chart-tmp/nginx/charts/
              rm -f .chart-tmp/nginx/Chart.lock

              # Update Chart.yaml to point to our GitHub repo
              sed -i 's|repository: oci://registry-1.docker.io/bitnamicharts|repository: https://portainer.github.io/test-public-repo|g' .chart-tmp/nginx/Chart.yaml

              helm package .chart-tmp/nginx --version "$VERSION" --app-version "$VERSION" -d .chart-out
              rm -rf .chart-tmp/nginx
            fi
          done

      - name: Ensure all required common chart versions are packaged
        run: |
          # Get all common versions required by packaged charts
          NEEDED_COMMON=$(for chart in .chart-out/{nginx,redis}-*.tgz; do
            if [ -f "$chart" ]; then
              tar -tzf "$chart" | grep "Chart.yaml$" | head -1 | xargs -I {} tar -xzOf "$chart" {} | yq -r '.dependencies[] | select(.name=="common") | .version' 2>/dev/null || true
            fi
          done | sort -u)

          # Also ensure the latest common is available
          LATEST_COMMON=$(helm search repo bitnami/common --versions -o json | jq -r '.[0].version')
          NEEDED_COMMON=$(echo -e "$NEEDED_COMMON\n$LATEST_COMMON" | sort -u)

          echo "üìã Common versions needed by packaged charts:"
          echo "$NEEDED_COMMON"

          # Get versions already packaged
          EXISTING_COMMON=$(yq -r '.entries.common[]?.version' .chart-out/index.yaml 2>/dev/null || echo "")

          # Package any missing versions
          for VERSION in $NEEDED_COMMON; do
            if echo "$EXISTING_COMMON" | grep -Fqx "$VERSION"; then
              echo "‚úÖ Common $VERSION already packaged"
            else
              echo "üì¶ Packaging common $VERSION (required by packaged charts)"
              helm pull bitnami/common --version "$VERSION" -d .chart-out
            fi
          done

      - name: Package local charts
        run: |
          for chart in $(find helm -maxdepth 1 -mindepth 1 -type d); do
            helm dependency update "$chart" || true
            helm package "$chart" -d .chart-out
          done

      - name: Show packaged charts
        run: ls -lh .chart-out/*.tgz || echo "‚ö†Ô∏è No charts found!"

      - name: Generate merged Helm index
        run: |
          helm repo index .chart-out \
            --url https://portainer.github.io/test-public-repo \
            --merge .chart-out/index.yaml

      - name: Prune old chart versions (keep latest 15 per chart)
        run: |
          set -euo pipefail
          for chart in $(yq -r '.entries | keys[]' .chart-out/index.yaml); do
            versions=$(yq -r ".entries[\"$chart\"][].version" .chart-out/index.yaml | sort -rV)
            keep=$(echo "$versions" | head -n 15)
            delete=$(comm -23 <(echo "$versions") <(echo "$keep") || true)

            for v in $delete; do
              echo "üóë Removing $chart-$v.tgz"
              rm -f .chart-out/$chart-$v.tgz
            done
          done

          # regenerate index cleanly after pruning
          helm repo index .chart-out \
            --url https://portainer.github.io/test-public-repo

      - name: Cleanup unused common chart versions
        run: |
          set -euo pipefail

          # Collect all common versions required by packaged charts
          REQUIRED_VERSIONS=$(for chart in .chart-out/{nginx,redis}-*.tgz; do
            if [ -f "$chart" ]; then
              # Extract Chart.yaml without using wildcards in tar
              tar -tzf "$chart" | grep "Chart.yaml$" | head -1 | xargs -I {} tar -xzOf "$chart" {} | yq -r '.dependencies[] | select(.name=="common") | .version' 2>/dev/null || true
            fi
          done | sort -u)

          echo "üîç Common versions required by packaged charts:"
          echo "$REQUIRED_VERSIONS"

          # Get all common versions currently in repository
          EXISTING_COMMON=$(yq -r '.entries.common[]?.version' .chart-out/index.yaml 2>/dev/null || echo "")

          # Remove only common versions that aren't referenced by any chart
          for VERSION in $EXISTING_COMMON; do
            if echo "$REQUIRED_VERSIONS" | grep -Fqx "$VERSION"; then
              echo "‚úÖ Keeping common $VERSION (required by at least one chart)"
            else
              echo "üóë Removing unused common $VERSION (not required by any packaged chart)"
              rm -f .chart-out/common-$VERSION.tgz
            fi
          done

          # regenerate index after cleanup
          helm repo index .chart-out \
            --url https://portainer.github.io/test-public-repo

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .chart-out
          publish_branch: gh-pages
