name: Harbor Charts Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *" # runs daily at 2 AM

jobs:
  sync-harbor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.15.0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get latest ORAS version
        id: oras_version
        run: |
          ver=$(curl -s https://api.github.com/repos/oras-project/oras/releases/latest | jq -r .tag_name)
          echo "version=${ver#v}" >> $GITHUB_OUTPUT

      - name: Install ORAS CLI
        uses: oras-project/setup-oras@v1
        with:
          version: ${{ steps.oras_version.outputs.version }}

      # Login to Harbor with robot (single-quote around username prevents shell $ expansion)
      - name: Login to Harbor (oras + helm)
        run: |
          echo "${{ secrets.HARBOR_ROBOT_TOKEN }}" | oras login harbor.portainercloud.io \
            -u '${{ secrets.HARBOR_ROBOT_USER }}' --password-stdin
          # helm needs its own registry login so helm chart push works
          echo "${{ secrets.HARBOR_ROBOT_TOKEN }}" | helm registry login harbor.portainercloud.io \
            -u '${{ secrets.HARBOR_ROBOT_USER }}' --password-stdin

      - name: Sync nginx charts (Bitnami -> Harbor, keep latest 15)
        run: |
          set -euo pipefail

          BITNAMI_REPO="https://charts.bitnami.com/bitnami"
          HARBOR_REPO="harbor.portainercloud.io/helm"
          KEEP=15

          mkdir -p packaged

          # ensure bitnami repo is available
          helm repo add bitnami "$BITNAMI_REPO" >/dev/null 2>&1 || true
          helm repo update

          echo "â†’ Getting latest ${KEEP} versions from Bitnami for nginx"
          # newest-first list (desc sort), keep only 15
          bitnami_versions=$(helm search repo bitnami/nginx --versions -o json \
            | jq -r '.[].version' \
            | sort -rV \
            | head -n ${KEEP} || true)

          echo "Bitnami latest versions (newest first):"
          echo "$bitnami_versions"

          # fetch Harbor tags once
          echo "â†’ Fetching existing tags from Harbor"
          harbor_tags=$(oras repo tags "${HARBOR_REPO}/nginx" 2>/dev/null || true)
          # normalize (one per line)
          echo "$harbor_tags" | sed '/^\s*$/d' > harbor_tags_nginx.txt

          #
          # For each version from Bitnami: push only if missing in Harbor
          #
          echo "â†’ Checking each Bitnami version against Harbor and pushing missing ones"
          # iterate newest-first so newest pushed first
          while IFS= read -r version; do
            [[ -z "$version" ]] && continue
            if echo "$harbor_tags" | grep -Fxq "$version"; then
              echo "  - $version already in Harbor -> skip"
              continue
            fi

            echo "  - $version missing in Harbor -> pulling & pushing"
            # pull and modify chart to remove OCI registry dependency
            helm pull bitnami/nginx --version "$version" --untar --destination .chart-tmp

            # Extract the actual common version required by this nginx version
            REQUIRED_COMMON=$(yq -r '.dependencies[] | select(.name=="common") | .version' .chart-tmp/nginx/Chart.yaml)
            echo "    nginx $version requires common $REQUIRED_COMMON"

            # Modify Chart.yaml to change repository to Harbor OCI registry (keep original version)
            sed -i 's|repository: oci://registry-1.docker.io/bitnamicharts|repository: oci://harbor.portainercloud.io/helm|g' .chart-tmp/nginx/Chart.yaml
            rm -f .chart-tmp/nginx/Chart.lock

            # Repackage the modified chart
            helm package .chart-tmp/nginx --destination packaged
            rm -rf .chart-tmp/nginx

            chart_file="packaged/nginx-$version.tgz"
            if [[ ! -f "$chart_file" ]]; then
              echo "ERROR: expected $chart_file to exist, aborting" >&2
              exit 1
            fi

            # Push using Helm OCI commands (requires helm registry login)
            echo "    â€¢ helm push -> ${HARBOR_REPO}/nginx:$version"
            helm push "$chart_file" "oci://${HARBOR_REPO}"

            # update local harbor_tags variable to include the new version so we don't re-push in same run
            harbor_tags="$(printf "%s\n%s" "$version" "$harbor_tags")"
          done <<< "$bitnami_versions"

          #
          # Prune Harbor: keep latest KEEP versions and delete the rest
          #
          echo "â†’ Pruning Harbor, keeping only the latest ${KEEP} versions"

          # list all versions in harbor (newest-first), fall back to empty if none
          all_versions=$(oras repo tags "${HARBOR_REPO}/nginx" 2>/dev/null || true)
          # sort newest-first by semver-like order
          all_versions_sorted=$(echo "$all_versions" | sort -rV)

          # compute versions to delete: lines starting at KEEP+1
          to_delete=$(echo "$all_versions_sorted" | sed -n "$((KEEP+1)),\$p" || true)

          if [[ -z "${to_delete//[$'\t\r\n ']}" ]]; then
            echo "No old versions to delete (Harbor has <= ${KEEP} versions)."
          else
            echo "Versions to delete:"
            echo "$to_delete"
            while IFS= read -r oldv; do
              [[ -z "$oldv" ]] && continue
              echo "  â€¢ Deleting ${HARBOR_REPO}/nginx:$oldv"
              # use oras manifest delete for the reference
              oras manifest delete "${HARBOR_REPO}/nginx:$oldv" --force || true
            done <<< "$to_delete"
          fi

      - name: Ensure all required common chart versions are in Harbor
        run: |
          set -euo pipefail
          HARBOR_REPO="harbor.portainercloud.io/helm"
          BITNAMI_REPO="https://charts.bitnami.com/bitnami"

          # Collect all common versions required by the latest 15 nginx versions from Bitnami
          echo "ðŸ“‹ Scanning Bitnami nginx versions for required common versions..."
          NEEDED_COMMON=""

          # Get all the latest nginx versions (same KEEP value as sync step)
          bitnami_versions=$(helm search repo bitnami/nginx --versions -o json \
            | jq -r '.[].version' \
            | sort -rV \
            | head -n 15 || true)

          for version in $bitnami_versions; do
            [[ -z "$version" ]] && continue
            echo "  Checking nginx $version..."
            # Pull and inspect to find common version
            if [ ! -d ".chart-tmp/nginx" ]; then
              helm pull bitnami/nginx --version "$version" --untar --destination .chart-tmp >/dev/null 2>&1 || continue
            fi

            if [ -f ".chart-tmp/nginx/Chart.yaml" ]; then
              common_ver=$(yq -r '.dependencies[] | select(.name=="common") | .version' .chart-tmp/nginx/Chart.yaml 2>/dev/null || true)
              if [[ -n "$common_ver" ]]; then
                echo "    â†’ requires common $common_ver"
                NEEDED_COMMON="$(echo -e "$NEEDED_COMMON\n$common_ver" | sort -u)"
              fi
              rm -rf .chart-tmp/nginx
            fi
          done

          # Also ensure the latest common is available
          LATEST_COMMON=$(helm search repo bitnami/common --versions -o json | jq -r '.[0].version' 2>/dev/null || true)
          if [[ -n "$LATEST_COMMON" ]]; then
            NEEDED_COMMON="$(echo -e "$NEEDED_COMMON\n$LATEST_COMMON" | sort -u)"
          fi

          # Clean up empty lines
          NEEDED_COMMON=$(echo "$NEEDED_COMMON" | sed '/^$/d' | sort -u)

          # Also ensure the latest common is available
          LATEST_COMMON=$(helm search repo bitnami/common --versions -o json | jq -r '.[0].version')
          NEEDED_COMMON=$(echo -e "$NEEDED_COMMON\n$LATEST_COMMON" | sort -u)

          echo "Common versions needed by packaged charts:"
          echo "$NEEDED_COMMON"

          # Get existing common versions in Harbor
          EXISTING_COMMON=$(oras repo tags "${HARBOR_REPO}/common" 2>/dev/null | sort -V || true)
          echo ""
          echo "Common versions already in Harbor:"
          echo "$EXISTING_COMMON"

          # Get available versions in Bitnami repo
          AVAILABLE_COMMON=$(helm search repo bitnami/common --versions -o json | jq -r '.[].version')

          # Push any missing required versions
          echo ""
          echo "Pushing missing common versions to Harbor..."
          for VERSION in $NEEDED_COMMON; do
            if echo "$EXISTING_COMMON" | grep -Fxq "$VERSION"; then
              echo "âœ… Common $VERSION already in Harbor"
            elif echo "$AVAILABLE_COMMON" | grep -Fxq "$VERSION"; then
              echo "ðŸ“¦ Pushing common $VERSION to Harbor (required by packaged nginx charts)"
              helm pull bitnami/common --version "$VERSION" --destination packaged
              chart_file="packaged/common-$VERSION.tgz"
              helm push "$chart_file" "oci://${HARBOR_REPO}"
            else
              echo "âš ï¸  Common $VERSION not available in Bitnami repo"
            fi
          done

          # Cleanup unused common versions from Harbor
          echo ""
          echo "Cleaning up unused common versions from Harbor..."
          for VERSION in $EXISTING_COMMON; do
            if echo "$NEEDED_COMMON" | grep -Fxq "$VERSION"; then
              echo "âœ… Keeping common $VERSION (required by packaged charts)"
            else
              echo "ðŸ—‘ Removing unused common $VERSION from Harbor"
              oras manifest delete "${HARBOR_REPO}/common:$VERSION" --force || true
            fi
          done

      # Package and push local nginx-multiple chart (kept as-is)
      - name: Package nginx-multiple chart
        run: |
          mkdir -p packaged
          helm package helm/nginx-multiple --destination packaged

      - name: Push nginx-multiple chart to Harbor
        run: |
          set -euo pipefail
          HARBOR_REPO="harbor.portainercloud.io/helm/nginx-multiple"
          LOCAL_VERSION=$(yq '.version' helm/nginx-multiple/Chart.yaml)

          echo "ðŸ“¦ Local chart version: $LOCAL_VERSION"

          # Fetch existing versions from Harbor (tags list)
          EXISTING_VERSIONS=$(oras repo tags "$HARBOR_REPO" 2>/dev/null | sort -V || true)
          LATEST_VERSION=$(echo "$EXISTING_VERSIONS" | tail -n1 || echo "")

          echo "ðŸ“¦ Latest Harbor version: $LATEST_VERSION"

          if [ -z "$LATEST_VERSION" ] || [ "$(printf '%s\n%s\n' "$LATEST_VERSION" "$LOCAL_VERSION" | sort -V | tail -n1)" != "$LATEST_VERSION" ]; then
            echo "ðŸš€ Newer version detected â€” pushing to Harbor..."

            chart_file=$(ls packaged/nginx-multiple-*.tgz | head -n 1)
            if [[ -z "$chart_file" ]]; then
              echo "No packaged nginx-multiple chart found, skipping push."
              exit 0
            fi

            # extract version from packaged file name (nginx-multiple-<version>.tgz)
            version=$(basename "$chart_file" | sed -E 's/^nginx-multiple-(.+)\.tgz$/\1/')
            NGINX_REPO="harbor.portainercloud.io/helm"

            echo "Saving and pushing nginx-multiple:$version to Harbor"
            helm push $chart_file "oci://${NGINX_REPO}"
          else
            echo "âœ… Chart version $LOCAL_VERSION is not newer than Harbor's $LATEST_VERSION â€” skipping push."
          fi  
